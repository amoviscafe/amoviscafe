<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Amovis Cafe ‚Äì Billing Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#141e30,#243b55);
  color:#fff;
}
.header{
  background:linear-gradient(90deg,#f7971e,#ffd200);
  color:#000;
  padding:14px;
  text-align:center;
  font-size:24px;
  font-weight:900;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:14px;
}
.bill-card{
  background:#1f1f1f;
  border-radius:20px;
  padding:16px;
  margin-bottom:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.6);
  position:relative;
}
.place-badge{
  position:absolute;
  top:-14px;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(90deg,#7f00ff,#e100ff);
  padding:6px 22px;
  border-radius:24px;
  font-size:16px;
  font-weight:900;
}
.customer{
  margin-top:22px;
  background:#0f172a;
  padding:10px;
  border-radius:12px;
  text-align:center;
}
.customer .name{
  font-size:18px;
  font-weight:900;
  color:#38bdf8;
}
.customer .mobile{
  font-size:14px;
  color:#a5f3fc;
}
.item{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:8px;
  padding:6px 0;
  border-bottom:1px dashed #444;
  font-size:14px;
}
.item.manual-item{
  background:linear-gradient(90deg,#6d28d9,#9333ea);
  padding:6px;
  border-radius:8px;
  font-weight:900;
}
.price{color:#22c55e;font-weight:900}
.del{
  width:22px;height:22px;
  border-radius:50%;
  border:none;
  background:#ef4444;
  color:#fff;
  cursor:pointer;
}
.manual{
  margin-top:10px;
  background:#111;
  padding:10px;
  border-radius:12px;
}
.manual-title{
  color:#22d3ee;
  font-weight:800;
  margin-bottom:6px;
}
.manual-row{
  display:grid;
  grid-template-columns:2fr 1fr 1fr;
  gap:6px;
}
.manual-row input{
  padding:6px;
  border-radius:6px;
  border:none;
}
.add-btn{
  margin-top:8px;
  width:100%;
  padding:8px;
  border:none;
  border-radius:14px;
  background:#00c6ff;
  font-weight:900;
}
.total{
  text-align:right;
  font-size:20px;
  font-weight:900;
  color:#22c55e;
  margin-top:10px;
}
.actions{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-top:12px;
}
.btn{
  padding:9px;
  border:none;
  border-radius:18px;
  font-size:13px;
  font-weight:900;
  cursor:pointer;
}
.qrbtn{background:#0ea5e9}
.imgbtn{background:#f97316}
.whatsapp{background:#22c55e}
.pay{background:#fde047;color:#000}
.qr-box{
  margin-top:10px;
  background:#fff;
  padding:10px;
  border-radius:12px;
  display:none;
  text-align:center;
}
.empty{
  text-align:center;
  font-size:18px;
  color:#ccc;
  margin-top:60px;
}

/* üî• PREMIUM POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.popup-box{
  background:#fff;
  padding:28px;
  border-radius:22px;
  text-align:center;
  color:#111;
  width:260px;
}
.popup-box .tick{
  width:60px;height:60px;
  background:#22c55e;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:30px;
  margin:0 auto 12px;
}

canvas{display:none}
</style>
</head>

<body>

<div class="header">üí≥ AMOVIS CAFE ‚Äì BILLING</div>

<div class="container">
  <div id="bills" class="empty">‚åõ Waiting for bills‚Ä¶</div>
</div>

<!-- PREMIUM SUCCESS POPUP -->
<div id="successPopup" class="popup">
  <div class="popup-box">
    <div class="tick">‚úî</div>
    <h3>Payment Successful</h3>
    <p>Order moved to history</p>
  </div>
</div>

<canvas id="billCanvas"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBymiTjjqUN-AAspzoA_bOGUWOzEc9o3jA",
  authDomain:"amovis-cafe-booking.firebaseapp.com",
  projectId:"amovis-cafe-booking"
});
const db=firebase.firestore();
const billsDiv=document.getElementById("bills");

const OWNER_UPI="amoviscafe@upi";
const OWNER_NAME="Amovis Cafe";

/* LOAD BILLS */
db.collection("orders").where("status","==","completed")
.onSnapshot(snapshot=>{
  billsDiv.innerHTML="";
  if(snapshot.empty){
    billsDiv.innerHTML='<div class="empty">No Bills</div>';return;
  }

  snapshot.forEach(doc=>{
    const d=doc.data();
    const place=d.type&&d.no?`${d.type.toUpperCase()} ${d.no}`:"DIRECT";

    let itemsHTML="",waText="",total=0;

    for(let n in d.items){
      const i=d.items[n];
      const amt=i.price*i.qty;
      total+=amt;
      const manualClass=i.addedBy==="billing"?"manual-item":"";

      itemsHTML+=`
      <div class="item ${manualClass}">
        <span>${n} √ó ${i.qty}</span>
        <span class="price">‚Çπ${amt}</span>
        <button class="del" onclick="removeItem('${doc.id}','${n}')">√ó</button>
      </div>`;

      waText+=`‚Ä¢ ${n} x${i.qty} = ‚Çπ${amt}\n`;
    }

    const waBill=
`‚òï AMOVIS CAFE
---------------------
üë§ ${d.customerName}
üìû ${d.customerMobile}
üìç ${place}

${waText}
---------------------
üí∞ TOTAL ‚Çπ${total}

Scan QR to pay
Thank you üòä`;

    billsDiv.innerHTML+=`
    <div class="bill-card">
      <div class="place-badge">${place}</div>

      <div class="customer">
        <div class="name">üë§ ${d.customerName}</div>
        <div class="mobile">üìû ${d.customerMobile}</div>
      </div>

      ${itemsHTML}

      <div class="manual">
        <div class="manual-title">‚ûï Manual Item</div>
        <div class="manual-row">
          <input id="n-${doc.id}" placeholder="Item">
          <input id="p-${doc.id}" type="number" placeholder="Price">
          <input id="q-${doc.id}" type="number" value="1">
        </div>
        <button class="add-btn" onclick="addManual('${doc.id}')">ADD</button>
      </div>

      <div class="total">TOTAL ‚Çπ ${total}</div>

      <div class="actions">
        <button class="btn qrbtn" onclick="generateQR('${doc.id}',${total})">üì∑ QR</button>
        <button class="btn imgbtn" onclick="downloadBillImage('${d.customerName}','${d.customerMobile}',\`${waText}\`,${total})">üñº BILL</button>
        <button class="btn whatsapp" onclick="sendWhatsApp('${d.customerMobile}',\`${waBill}\`)">üí¨ WhatsApp</button>
        <button class="btn pay" onclick="markPaid('${doc.id}')">‚úÖ DONE</button>
      </div>

      <div class="qr-box" id="qr-${doc.id}"></div>
    </div>`;
  });
});

/* MANUAL ADD */
function addManual(id){
  const n=document.getElementById(`n-${id}`).value;
  const p=Number(document.getElementById(`p-${id}`).value);
  const q=Number(document.getElementById(`q-${id}`).value);
  if(!n||p<=0||q<=0)return;

  db.collection("orders").doc(id).update({
    [`items.${n}`]:{price:p,qty:q,addedBy:"billing"}
  });
}

/* REMOVE */
function removeItem(id,n){
  if(confirm("Remove item?")){
    db.collection("orders").doc(id).update({
      [`items.${n}`]:firebase.firestore.FieldValue.delete()
    });
  }
}

/* QR */
function generateQR(id,total){
  const box=document.getElementById(`qr-${id}`);
  box.innerHTML="";
  box.style.display="block";
  new QRCode(box,{
    text:`upi://pay?pa=${OWNER_UPI}&pn=${OWNER_NAME}&am=${total}&cu=INR`,
    width:120,height:120
  });
}

/* WHATSAPP */
function sendWhatsApp(m,msg){
  window.open(`https://wa.me/91${m}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ‚úÖ FIXED DONE */
function markPaid(id){
  db.collection("orders").doc(id).update({
    status:"COMPLETED",
    paymentMode:"UPI",
    completedAt:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    const p=document.getElementById("successPopup");
    p.style.display="flex";
    setTimeout(()=>p.style.display="none",1800);
  });
}
</script>

</body>
</html>
